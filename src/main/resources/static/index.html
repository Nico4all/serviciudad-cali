<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServiCiudad Cali - Consulta de Facturas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .login-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 450px;
        width: 100%;
      }
      .dashboard-container {
        padding: 20px;
        display: none;
      }
      .dashboard-header {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .service-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }
      .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      .total-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .service-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }
      .energia-icon {
        color: #ffd700;
      }
      .acueducto-icon {
        color: #4a90e2;
      }
      .btn-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .btn-custom:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
      }
      .spinner-container {
        display: none;
        text-align: center;
        padding: 20px;
      }
      .logo-title {
        color: #667eea;
        font-weight: 700;
        font-size: 2rem;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #6c757d;
        margin-bottom: 30px;
      }
      .value-amount {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
      }
      .total-amount {
        font-size: 2.5rem;
        font-weight: 700;
      }
      .period-badge {
        background: #e7e7ff;
        color: #667eea;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
      }
      .alert-custom {
        border-radius: 10px;
        border: none;
      }
      @media (max-width: 768px) {
        .login-card {
          margin: 20px;
          padding: 30px 20px;
        }
        .dashboard-header {
          padding: 20px;
        }
        .service-card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginScreen">
      <div class="login-card">
        <div class="text-center">
          <i class="fas fa-file-invoice-dollar fa-4x text-primary mb-3"></i>
          <h1 class="logo-title">ServiCiudad Cali</h1>
          <p class="subtitle">Consulta Unificada de Facturas</p>
        </div>

        <div id="alertContainer"></div>

        <form id="loginForm">
          <div class="mb-4">
            <label for="documento" class="form-label fw-bold"
              >Número de Documento</label
            >
            <input
              type="text"
              class="form-control form-control-lg"
              id="documento"
              placeholder="Ingrese su número de documento"
              required
            />
            <small class="text-muted">Ejemplo: 0001234567</small>
          </div>
          <button type="submit" class="btn btn-custom w-100 btn-lg">
            <i class="fas fa-search me-2"></i>Consultar Facturas
          </button>
        </form>

        <div class="spinner-container" id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2 text-muted">Consultando información...</p>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardScreen">
      <div class="container-fluid">
        <!-- Header -->
        <div class="dashboard-header">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="mb-2">
                <i class="fas fa-user-circle me-2"></i
                ><span id="nombreCliente"></span>
              </h2>
              <p class="mb-0 text-muted">
                <i class="fas fa-id-card me-2"></i>Documento:
                <strong id="documentoCliente"></strong>
                <span class="ms-3"
                  ><i class="fas fa-calendar-alt me-2"></i>Fecha:
                  <strong id="fechaConsulta"></strong
                ></span>
              </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <button class="btn btn-outline-secondary" id="btnNuevaConsulta">
                <i class="fas fa-redo me-2"></i>Nueva Consulta
              </button>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Card Energía -->
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="service-card">
              <div class="text-center">
                <i class="fas fa-bolt service-icon energia-icon"></i>
                <h3 class="mb-3">Energía Eléctrica</h3>
              </div>
              <div class="mb-3">
                <span class="period-badge"
                  ><i class="fas fa-calendar me-1"></i
                  ><span id="energiaPeriodo"></span
                ></span>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Consumo</label>
                <p class="h5" id="energiaConsumo"></p>
              </div>
              <div>
                <label class="text-muted small">Valor a Pagar</label>
                <p class="value-amount" id="energiaValor"></p>
              </div>
            </div>
          </div>

          <!-- Card Acueducto -->
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="service-card">
              <div class="text-center">
                <i class="fas fa-tint service-icon acueducto-icon"></i>
                <h3 class="mb-3">Acueducto</h3>
              </div>
              <div class="mb-3">
                <span class="period-badge"
                  ><i class="fas fa-calendar me-1"></i
                  ><span id="acueductoPeriodo"></span
                ></span>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Consumo</label>
                <p class="h5" id="acueductoConsumo"></p>
              </div>
              <div>
                <label class="text-muted small">Valor a Pagar</label>
                <p class="value-amount" id="acueductoValor"></p>
              </div>
            </div>
          </div>

          <!-- Card Total -->
          <div class="col-md-12 col-lg-4 mb-4">
            <div class="total-card">
              <div class="text-center">
                <i class="fas fa-money-bill-wave service-icon"></i>
                <h3 class="mb-4">Total a Pagar</h3>
                <div class="total-amount" id="totalPagar"></div>
                <p class="mt-3 mb-0 opacity-75">
                  <i class="fas fa-info-circle me-2"></i>Energía + Acueducto
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Información adicional -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="alert alert-info alert-custom">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Información:</strong> Los valores mostrados corresponden
              al período más reciente registrado en el sistema.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Configuración de la API
      const API_BASE_URL = "http://localhost:8080";

      // Formatear números como moneda colombiana
      function formatCurrency(value) {
        return new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 2,
        }).format(value);
      }

      // Formatear período (YYYYMM a texto legible)
      function formatPeriod(period) {
        if (!period) return "N/A";
        const year = period.substring(0, 4);
        const month = period.substring(4, 6);
        const months = [
          "Ene",
          "Feb",
          "Mar",
          "Abr",
          "May",
          "Jun",
          "Jul",
          "Ago",
          "Sep",
          "Oct",
          "Nov",
          "Dic",
        ];
        return `${months[parseInt(month) - 1]} ${year}`;
      }

      // Formatear fecha
      function formatDate(isoDate) {
        const date = new Date(isoDate);
        return date.toLocaleDateString("es-CO", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      // Mostrar alerta
      function showAlert(message, type = "danger") {
        const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show alert-custom" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        $("#alertContainer").html(alertHtml);
      }

      // Consultar facturas
      function consultarFacturas(documento) {
        $("#loadingSpinner").show();
        $("#loginForm").hide();
        $("#alertContainer").empty();

        $.ajax({
          url: `${API_BASE_URL}/servicios/${documento}`,
          method: "GET",
          success: function (data) {
            mostrarDashboard(data);
          },
          error: function (xhr) {
            $("#loadingSpinner").hide();
            $("#loginForm").show();

            let errorMsg = "Error al consultar las facturas. ";
            if (xhr.status === 404) {
              errorMsg += "No se encontró información para este documento.";
            } else if (xhr.status === 0) {
              errorMsg +=
                "No se pudo conectar con el servidor. Verifique que el backend esté ejecutándose.";
            } else {
              errorMsg += "Por favor, intente nuevamente.";
            }
            showAlert(errorMsg);
          },
        });
      }

      // Mostrar dashboard con los datos
      function mostrarDashboard(data) {
        // Llenar información del cliente
        $("#nombreCliente").text(data.nombreCliente || "Cliente");
        $("#documentoCliente").text(data.clienteId);
        $("#fechaConsulta").text(formatDate(data.fechaConsulta));

        // Llenar información de energía
        if (data.energia) {
          $("#energiaPeriodo").text(formatPeriod(data.energia.periodo));
          $("#energiaConsumo").text(data.energia.consumo || "N/A");
          $("#energiaValor").text(formatCurrency(data.energia.valorPagar));
        }

        // Llenar información de acueducto
        if (data.acueducto) {
          $("#acueductoPeriodo").text(formatPeriod(data.acueducto.periodo));
          $("#acueductoConsumo").text(data.acueducto.consumo || "N/A");
          $("#acueductoValor").text(formatCurrency(data.acueducto.valorPagar));
        }

        // Mostrar total
        $("#totalPagar").text(formatCurrency(data.totalAPagar));

        // Cambiar a vista de dashboard
        $("#loginScreen").hide();
        $("#dashboardScreen").fadeIn();
      }

      // Event Listeners
      $(document).ready(function () {
        // Submit del formulario
        $("#loginForm").on("submit", function (e) {
          e.preventDefault();
          const documento = $("#documento").val().trim();

          if (documento) {
            consultarFacturas(documento);
          } else {
            showAlert("Por favor, ingrese un número de documento válido.");
          }
        });

        // Botón nueva consulta
        $("#btnNuevaConsulta").on("click", function () {
          $("#dashboardScreen").hide();
          $("#loginScreen").fadeIn();
          $("#loginForm").show();
          $("#loadingSpinner").hide();
          $("#documento").val("");
          $("#alertContainer").empty();
        });

        // Permitir solo números en el campo documento
        $("#documento").on("input", function () {
          this.value = this.value.replace(/[^0-9]/g, "");
        });
      });
    </script>
  </body>
</html>
